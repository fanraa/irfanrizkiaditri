<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanra CollabBoard</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* ========================================================= */
        /* TEMA GLOBAL & KONSISTENSI */
        /* ========================================================= */
        :root{
            --bg:#0d0d0f;
            --card:#141418;
            --text:#ffffff;
            --accent:#4fa3ff; 
            --accent-2:#7c3aed; 
            --muted:#9da3b3;
            --glass:rgba(255,255,255,0.06);
            --card-border:rgba(255,255,255,0.06);
            --danger: #ef4444;
            --success: #22c55e;
            --canvas-bg: #1f2128; 
        }
        [data-theme="light"]{
            --bg:#f6f8fb;
            --card:#ffffff;
            --text:#0b1220;
            --accent:#007bff; 
            --accent-2:#5856d6; 
            --muted:#6b7280; 
            --glass:rgba(0,0,0,0.05);
            --card-border:rgba(0,0,0,0.08);
            --danger: #dc2626;
            --success: #16a34a;
            --canvas-bg: #ffffff;
        }
        html{
            font-family:"Poppins",sans-serif;
            font-size:clamp(14px,1.6vw,16px);
            -webkit-font-smoothing: antialiased;
            overflow:hidden;
            scroll-behavior: smooth;
            height: 100%;
        }
        *{ margin:0; padding:0; box-sizing:border-box; }
        body{
            background:var(--bg);
            color:var(--text);
            height:100vh;
            display: flex;
            flex-direction: column;
            transition:background .25s ease, color .25s ease;
        }
        a{ text-decoration:none; color:inherit; }
        button { cursor: pointer; border: none; background: none; color: inherit; font-family: inherit; }

        /* ... (Kontrol Form, Button, dll tetap sama) ... */
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 10px 15px; border: 1px solid var(--card-border);
            border-radius: 8px; background: var(--glass); color: var(--text);
            font-family: inherit; font-size: 1rem; transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--accent); }
        .btn-action {
            width: 100%; padding: 12px; border-radius: 8px; font-weight: 600;
            margin-top: 10px; transition: opacity 0.2s; cursor: pointer;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { filter: brightness(1.2); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-secondary { background: var(--glass); border: 1px solid var(--card-border); color: var(--text); }


        /* ========================================================= */
        /* HEADER */
        /* ========================================================= */
        header{
            position:sticky; top:0; left:0; width:100%;
            background:var(--card); 
            border-bottom:1px solid var(--card-border);
            z-index:1500;
            flex-shrink: 0;
        }
        .container{ width:min(94%, 1200px); margin:0 auto; }
        .navbar{
            display:flex; align-items:center;
            padding:16px 0;
        }
        .logo{
            display:flex; align-items:center; gap:10px;
            font-weight:700; font-size:1.15rem;
        }
        .logo i{ color:var(--accent); font-size:1.2rem; }
        .logo span{ color:var(--accent); }
        .nav-wrap{
            margin-left:auto;
            display:flex; align-items:center; gap:14px;
        }
        .nav-links{ 
            display:flex; gap:20px; list-style:none; align-items: center; 
        }
        .nav-links a{ 
            padding:6px 10px; font-weight:500; border-radius:8px; 
            position:relative; transition:.25s; cursor: pointer; 
            display: flex; align-items: center; gap: 8px;
        }
        .nav-links a:hover{ color:var(--accent); transform:translateY(-2px); }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 5px; z-index: 2000; }
        @media(max-width: 768px){ .nav-links{display:none;} .mobile-menu-btn { display: block; } .navbar { padding: 16px; } }
        .theme-toggle{ cursor:pointer; display:flex; align-items:center; padding:6px 10px; font-weight:500; border-radius:8px; position:relative; transition:.25s; }
        .theme-toggle:hover { transform:translateY(-2px); }
        .switch{ width:46px; height:26px; background:var(--glass); border:1px solid var(--card-border); border-radius:20px; position:relative; padding:3px; backdrop-filter:blur(5px); }
        .knob{ width:20px; height:20px; background:#fff; border-radius:50%; position:absolute; top:3px; left:3px; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:.25s; }
        [data-theme="light"] .switch{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); }
        [data-theme="light"] .knob{ left:23px; }

        /* ========================================================= */
        /* AUTH & MODALS */
        /* ========================================================= */
        #auth-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 5000;
        }
        .auth-card {
            background: var(--card); border: 1px solid var(--card-border); border-radius: 16px;
            padding: 40px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .google-login-btn {
            background: #fff; color: #333; border-radius: 8px; padding: 12px 20px;
            font-size: 1rem; font-weight: 600; display: inline-flex; align-items: center; gap: 12px; transition: background 0.2s;
        }
        .google-login-btn:hover { background: #eee; }
        .google-login-btn i { color: #DB4437; font-size: 1.2rem; }
        
        /* Modal Overlay (Umum untuk Settings & Confirm) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 4000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--card); border: 1px solid var(--card-border); border-radius: 16px; width: 90%; max-width: 500px;
            padding: 30px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--card-border); padding-bottom: 15px;
        }
        .modal-header h2 { margin: 0; color: var(--accent); font-size: 1.5rem; }
        .modal-close-btn {
            background: var(--glass); border: 1px solid var(--card-border);
            width: 36px; height: 36px; border-radius: 50%; transition: background 0.2s;
        }
        .modal-close-btn:hover { background: var(--accent-2); }
        .settings-section {
            margin-bottom: 20px; padding-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
        }
        
        /* [BARU] Style untuk Confirm Modal */
        #confirm-modal-content .modal-body {
            color: var(--muted);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        #confirm-modal-content .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #confirm-btn-yes {
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        #confirm-btn-no {
            background: var(--glass);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            border: 1px solid var(--card-border);
        }

        /* ========================================================= */
        /* CSS APLIKASI GAMBAR */
        /* ========================================================= */
        
        #app-container {
            flex: 1; display: flex; overflow: hidden; position: relative;
        }
        
        /* 1. Lobi Room */
        #room-lobby {
            width: 100%; height: 100%; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 30px;
        }
        .lobby-section {
            background: var(--card); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 20px;
        }
        .lobby-section h2 {
            color: var(--accent); border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px; margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--muted); }
        #room-list { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; }
        .room-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: var(--glass); border-radius: 8px; border: 1px solid var(--card-border);
        }
        .room-item-info strong { display: block; }
        .room-item-info span { font-size: 0.8rem; color: var(--muted); }
        
        /* 2. Kontainer Menggambar */
        #drawing-container {
            flex: 1; position: relative; display: none;
        }
        #drawing-canvas {
            display: block; width: 100%; height: 100%;
            background: var(--canvas-bg); cursor: crosshair;
        }
        
        /* 3. Toolbar */
        #toolbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
            display: flex; align-items: center; gap: 8px; padding: 8px;
            background: var(--card); border: 1px solid var(--card-border); border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            transition: opacity 0.3s ease, transform 0.3s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease;
        }
        #toolbar.toolbar-hidden {
            opacity: 0; pointer-events: none; transform: translateX(-50%) translateY(-20px); 
        }
        .tool {
            width: 40px; height: 40px; border-radius: 8px; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; color: var(--muted);
        }
        .tool:hover { background: var(--glass); color: var(--text); }
        .tool.active { background: var(--accent); color: white; }
        #color-picker {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 40px; padding: 0; border: none;
            border-radius: 8px; overflow: hidden; cursor: pointer;
        }
        #color-picker::-webkit-color-swatch { border: none; border-radius: 8px; }
        #color-picker::-moz-color-swatch { border: none; border-radius: 8px; }
        .tool-separator { width: 1px; height: 30px; background: var(--card-border); margin: 0 5px; }
        #size-slider { width: 100px; cursor: pointer; }

        @media (max-width: 600px) {
            #toolbar {
                left: 10px; right: 10px; top: 10px; width: auto; transform: translateX(0);
                flex-wrap: wrap; justify-content: center; gap: 6px; padding: 6px;
            }
            #toolbar.toolbar-hidden { opacity: 0; pointer-events: none; transform: translateY(-20px); }
            #size-slider { width: 80px; }
            .tool { width: 36px; height: 36px; font-size: 1rem; }
            #color-picker, #color-picker::-webkit-color-swatch, #color-picker::-moz-color-swatch { width: 36px; height: 36px; }
        }
        
        /* 4. Daftar Pengguna */
        #user-list-sidebar {
            width: 240px; height: 100%; flex-shrink: 0; background: var(--card);
            border-left: 1px solid var(--card-border); padding: 15px;
            display: none; flex-direction: column; overflow-y: auto;
        }
        #user-list-sidebar h4 {
            color: var(--accent-2); border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .user-item {
            display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
        }
        .user-item img { width: 32px; height: 32px; border-radius: 50%; }
        .user-item-info { flex: 1; } /* [UBAH] Agar tombol kick ke kanan */
        .user-item-info strong { display: block; font-size: 0.9rem; }
        .user-item-info span { font-size: 0.8rem; color: var(--muted); font-style: italic; }
        .user-item-info span.drawing { color: var(--accent); font-weight: 600; }
        
        /* [BARU] Tombol Kick */
        .kick-btn {
            background: var(--glass);
            color: var(--danger);
            width: 32px; height: 32px;
            border-radius: 50%;
            font-size: 0.9rem;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .kick-btn:hover {
            background: var(--danger);
            color: white;
        }

        @media (max-width: 768px) { #user-list-sidebar { display: none !important; } }

        /* [BARU] 5. Notifikasi Toast */
        #toast-container {
            position: fixed;
            top: 80px; /* Di bawah header */
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: var(--card);
            color: var(--text);
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toast-in 0.3s ease;
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.3s ease;
            min-width: 250px;
        }
        .toast.toast-error { border-left: 4px solid var(--danger); }
        .toast.toast-success { border-left: 4px solid var(--success); }
        .toast.toast-info { border-left: 4px solid var(--accent); }
        
        .toast i { font-size: 1.2rem; }
        .toast.toast-error i { color: var(--danger); }
        .toast.toast-success i { color: var(--success); }
        .toast.toast-info i { color: var(--accent); }
        
        .toast.toast-fade-out {
            opacity: 0;
            transform: translateX(20px);
        }

        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body data-theme="dark">
    
    <header>
      <nav class="container navbar">
        <a class="logo" href="#"><i class="fas fa-palette"></i> <span>Fanra</span>Board</a>
        <div class="nav-wrap">
          <div class="nav-links">
            <a id="leave-room-btn" style="display: none;"><i class="fas fa-door-open"></i> Keluar Room</a>
            <a id="header-settings-btn"><i class="fas fa-cog"></i> Pengaturan</a>
            <div class="theme-toggle" id="themeToggle" role="button" aria-pressed="false" tabindex="0" title="Toggle theme">
                <div class="switch" aria-hidden="true"><div class="knob"></div></div>
            </div>
            <a href="javascript:history.back()"><i class="fas fa-arrow-left"></i> Kembali</a>
          </div>
          <button class="mobile-menu-btn" id="mobile-sidebar-toggle">
              <i class="fas fa-bars"></i>
          </button>
        </div>
      </nav>
    </header>

    <div id="app-container" style="display: none;">
        
        <div id="room-lobby">
            <div class="lobby-section">
                <h2>Papan Publik</h2>
                <p style="color: var(--muted); margin-bottom: 20px;">Bergabung ke papan gambar publik di mana semua orang bisa menggambar bersama.</p>
                <button class="btn-action btn-primary" id="join-public-btn"><i class="fas fa-users"></i> Gabung Papan Publik</button>
            </div>
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div class="lobby-section" style="flex: 1; min-width: 300px;">
                    <h2>Buat Room Baru</h2>
                    <form id="create-room-form">
                        <div class="form-group"><label for="room-name">Nama Room</label><input type="text" id="room-name" placeholder="Mis: Ruang Seni" required></div>
                        <div class="form-group"><label for="room-password">Kata Sandi (Opsional)</label><input type="password" id="room-password" placeholder="Kosongkan untuk publik"></div>
                        <button type="submit" class="btn-action btn-primary"><i class="fas fa-plus"></i> Buat Room</button>
                    </form>
                </div>
                <div class="lobby-section" style="flex: 1; min-width: 300px;">
                    <h2>Gabung Room</h2>
                    <form id="join-room-form">
                        <div class="form-group"><label for="join-room-id">ID Room</label><input type="text" id="join-room-id" placeholder="Masukkan ID Room" required></div>
                        <div class="form-group"><label for="join-room-password">Kata Sandi</label><input type="password" id="join-room-password" placeholder="Masukkan kata sandi jika perlu"></div>
                        <button type="submit" class="btn-action btn-secondary"><i class="fas fa-sign-in-alt"></i> Gabung</button>
                    </form>
                </div>
            </div>
            <div class="lobby-section">
                <h2>Room Publik Tersedia</h2>
                <div id="room-list"><p style="color: var(--muted); text-align: center;">Memuat room...</p></div>
            </div>
        </div>

        <div id="drawing-container">
            <div id="toolbar">
                <button class="tool active" id="tool-pen" title="Pena"><i class="fas fa-pencil-alt"></i></button>
                <button class="tool" id="tool-marker" title="Marker/Highlighter"><i class="fas fa-highlighter"></i></button>
                <button class="tool" id="tool-eraser" title="Penghapus"><i class="fas fa-eraser"></i></button>
                
                <button class="tool" id="tool-text" title="Teks (Segera)" disabled style="opacity: 0.4;"><i class="fas fa-font"></i></button>
                
                <div class="tool-separator"></div>
                
                <input type="color" class="tool" id="color-picker" value="#FFFFFF" title="Pilih Warna">
                <input type="range" id="size-slider" min="1" max="50" value="5" title="Ukuran Kuas">
                
                <div class="tool-separator"></div>
                
                <button class="tool" id="tool-lock" title="Lindungi Goresan (Segera)" disabled style="opacity: 0.4;"><i class="fas fa-lock-open"></i></button>
                <button class="tool" id="clear-my-canvas" title="Hapus Goresan Saya"><i class="fas fa-user-slash"></i></button>
                
                <button class="tool" id="clear-canvas" title="Bersihkan Papan (Owner)" style="display: none;"><i class="fas fa-trash"></i></button>
                
                <button class="tool" id="download-btn" title="Unduh Gambar"><i class="fas fa-download"></i></button>
            </div>
            
            <canvas id="drawing-canvas"></canvas>
        </div>
        
        <div id="user-list-sidebar" style="display: none;">
            <h4><i class="fas fa-users"></i> Aktif di Room Ini</h4>
            <div id="user-list-content"><p style="color: var(--muted);">Memuat...</p></div>
        </div>

    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Selamat Datang di FanraBoard</h2>
            <p style="color: var(--muted); margin-bottom: 25px;">Silakan masuk dengan Google untuk mulai menggambar.</p>
            <button class="google-login-btn" id="google-login-button">
                <i class="fab fa-google"></i> Masuk dengan Google
            </button>
        </div>
    </div>
    
    <div class="modal-overlay" id="settings-modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pengaturan Akun</h2>
                <button class="modal-close-btn" data-close-modal="settings-modal-overlay"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-section">
                <h3>Info Akun</h3>
                <label for="new-username-input" style="display: block; margin: 15px 0 8px;">Ganti Username:</label>
                <input type="text" id="new-username-input" placeholder="Masukkan username baru" style="margin-bottom: 10px;">
                <button class="btn-action btn-primary" id="update-username-button">Simpan Username</button>
            </div>
            <div class="settings-section">
                <h3>Akses & Keamanan</h3>
                <button class="btn-action btn-secondary" id="logout-button">
                    <i class="fas fa-sign-out-alt"></i> Logout Akun
                </button>
            </div>
            <div class="settings-section" id="owner-actions-section" style="display: none;">
                <h3>Moderasi Room (Owner)</h3>
                <button class="btn-action btn-danger" id="delete-room-btn">
                    <i class="fas fa-bomb"></i> Hapus Room Ini
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirm-modal-overlay">
        <div class="modal-content" id="confirm-modal-content">
            <div class="modal-header">
                <h2 id="confirm-modal-title">Konfirmasi Tindakan</h2>
            </div>
            <div class="modal-body" id="confirm-modal-text">
                Anda yakin ingin melanjutkan?
            </div>
            <div class="modal-footer">
                <button id="confirm-btn-no">Batal</button>
                <button id="confirm-btn-yes">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>


    <div id="toast-container"></div>


    <script>
        // =========================================================
        // JAVASCRIPT APLIKASI GAMBAR
        // =========================================================

        // 1. Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVYfH91lXeOIkLFXmk_rRsObNbo4n-G_A",
            authDomain: "portofolio-fanra.firebaseapp.com",
            projectId: "portofolio-fanra",
            storageBucket: "portofolio-fanra.firebasestorage.app",
            messagingSenderId: "1048993283215",
            appId: "1:1048993283215:web:137862db54a113409404fa",
        };
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        
        let currentUser = null; 

        // =========================================================
        // 2. DOM Elements
        // =========================================================
        const root = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        
        // ... (DOM Layar, Header, Lobi, Auth, Modal) ...
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const roomLobby = document.getElementById('room-lobby');
        const drawingContainer = document.getElementById('drawing-container');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const headerSettingsBtn = document.getElementById('header-settings-btn');
        const joinPublicBtn = document.getElementById('join-public-btn');
        const createRoomForm = document.getElementById('create-room-form');
        const joinRoomForm = document.getElementById('join-room-form');
        const roomList = document.getElementById('room-list');
        const googleLoginButton = document.getElementById('google-login-button');
        const settingsModal = document.getElementById('settings-modal-overlay');
        const updateUsernameButton = document.getElementById('update-username-button');
        const newUsernameInput = document.getElementById('new-username-input');
        const logoutButton = document.getElementById('logout-button');

        // ... (DOM Canvas & Tools) ...
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const toolbar = document.getElementById('toolbar');
        const toolPen = document.getElementById('tool-pen');
        const toolMarker = document.getElementById('tool-marker');
        const toolEraser = document.getElementById('tool-eraser');
        const colorPicker = document.getElementById('color-picker');
        const sizeSlider = document.getElementById('size-slider');
        const clearCanvasBtn = document.getElementById('clear-canvas');
        const clearMyCanvasBtn = document.getElementById('clear-my-canvas');
        const downloadBtn = document.getElementById('download-btn');
        
        // ... (DOM Daftar Pengguna) ...
        const userListSidebar = document.getElementById('user-list-sidebar');
        const userListContent = document.getElementById('user-list-content');

        // [BARU] DOM Toast & Confirm
        const toastContainer = document.getElementById('toast-container');
        const confirmModal = document.getElementById('confirm-modal-overlay');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmBtnYes = document.getElementById('confirm-btn-yes');
        const confirmBtnNo = document.getElementById('confirm-btn-no');

        // [BARU] DOM Owner
        const ownerActionsSection = document.getElementById('owner-actions-section');
        const deleteRoomBtn = document.getElementById('delete-room-btn');


        // =========================================================
        // 3. State Aplikasi
        // =========================================================
        let currentRoomId = null;
        let currentRoomData = null; // [BARU] Untuk simpan data room (termasuk creatorId)
        let isRoomOwner = false; // [BARU] Status apakah user ini owner
        
        let drawingListener = null; 
        let roomListListener = null;
        let roomUsersListener = null; 
        let myStatusListener = null; // [BARU] Untuk deteksi jika di-kick
        let roomDocListener = null; // [BARU] Untuk deteksi jika room dihapus
        let userPresenceInterval = null; 
        let allStrokes = []; 
        
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#FFFFFF';
        let currentSize = 5;
        let currentStroke = { points: [] };
        
        let confirmCallback = null; // [BARU] Untuk menyimpan fungsi callback modal
        
        // =========================================================
        // 4. UI/UX (Toast, Confirm, Fullscreen, Tema, Modal, View)
        // =========================================================

        // [BARU] Fungsi Notifikasi Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = 'fas fa-info-circle';
            if (type === 'error') icon = 'fas fa-exclamation-triangle';
            if (type === 'success') icon = 'fas fa-check-circle';
            
            toast.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // [BARU] Fungsi Modal Konfirmasi
        function showConfirm(title, message, onConfirmCallback) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = message;
            confirmCallback = onConfirmCallback; // Simpan callback
            confirmModal.classList.add('active');
        }
        
        // Listener untuk tombol modal konfirmasi
        confirmBtnNo.addEventListener('click', () => {
            confirmModal.classList.remove('active');
            confirmCallback = null;
        });
        
        confirmBtnYes.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(); // Jalankan callback
            }
            confirmModal.classList.remove('active');
            confirmCallback = null;
        });


        // [BARU] Fungsi Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showToast(`Gagal fullscreen: ${err.message}`, 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // [PERUBAHAN] GANTI fungsi showView
        function showView(viewName) {
            roomLobby.style.display = 'none';
            drawingContainer.style.display = 'none';
            leaveRoomBtn.style.display = 'none';
            userListSidebar.style.display = 'none';
            ownerActionsSection.style.display = 'none'; // Sembunyikan tombol owner
            clearCanvasBtn.style.display = 'none'; 
            
            if (viewName === 'lobby') {
                roomLobby.style.display = 'flex';
                isRoomOwner = false; // Reset status owner
                currentRoomData = null;
            } else if (viewName === 'drawing') {
                drawingContainer.style.display = 'flex';
                leaveRoomBtn.style.display = 'flex';
                userListSidebar.style.display = 'flex';
                resizeCanvas();
                updateOwnerUI(); // [BARU] Panggil fungsi untuk tampilkan UI owner
            }
        }
        
        // [BARU] Fungsi untuk update UI khusus Owner
        function updateOwnerUI() {
            if (isRoomOwner) {
                clearCanvasBtn.style.display = 'flex';
                ownerActionsSection.style.display = 'block';
            } else {
                clearCanvasBtn.style.display = 'none';
                ownerActionsSection.style.display = 'none';
            }
        }
        
        // ... (Logika Tema & Modal tetap sama, ganti alert ke showToast) ...
        const savedTheme = localStorage.getItem('site_theme') || 'dark';
        root.setAttribute('data-theme', savedTheme);
        themeToggle.setAttribute('aria-pressed', savedTheme === 'light');
        function setTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('site_theme', t); themeToggle.setAttribute('aria-pressed', t === 'light'); }
        themeToggle.addEventListener('click', () => { const now = root.getAttribute('data-theme'); setTheme(now === 'light' ? 'dark' : 'light'); });
        document.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => { document.getElementById(btn.getAttribute('data-close-modal')).classList.remove('active'); }); });
        headerSettingsBtn.addEventListener('click', () => { if (currentUser) { newUsernameInput.value = currentUser.displayName || ''; } settingsModal.classList.add('active'); });

        // =========================================================
        // 5. Logika Lobi & Room
        // =========================================================
        
        // ... (listenForPublicRooms tetap sama) ...
        function listenForPublicRooms() {
            if (roomListListener) roomListListener(); 
            roomListListener = db.collection('drawingRooms').where('isPublic', '==', true).orderBy('createdAt', 'desc').limit(10)
                .onSnapshot(snapshot => {
                    roomList.innerHTML = '';
                    if (snapshot.empty) { roomList.innerHTML = '<p style="color: var(--muted); text-align: center;">Belum ada room publik.</p>'; return; }
                    snapshot.forEach(doc => {
                        const room = doc.data();
                        const roomEl = document.createElement('div');
                        roomEl.className = 'room-item';
                        roomEl.innerHTML = `<div class="room-item-info"><strong>${room.name}</strong><span>ID: ${doc.id} (oleh ${room.creatorName || 'Anonim'})</span></div><button class="btn-action btn-secondary" style="width: auto; padding: 8px 12px; margin: 0;">Gabung</button>`;
                        roomEl.querySelector('button').addEventListener('click', () => { joinRoom(doc.id); });
                        roomList.appendChild(roomEl);
                    });
                }, error => { console.error("Error memuat room: ", error); roomList.innerHTML = '<p style="color: var(--danger); text-align: center;">Gagal memuat room.</p>'; });
        }
        
        // [PERUBAHAN] GANTI createRoomForm (ganti alert, simpan creatorId)
        createRoomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomName = document.getElementById('room-name').value;
            const password = document.getElementById('room-password').value;
            if (!roomName) { showToast('Nama room tidak boleh kosong!', 'error'); return; }
            try {
                const docRef = await db.collection('drawingRooms').add({
                    name: roomName,
                    password: password || null,
                    isPublic: !password,
                    creatorId: currentUser.uid, // [PENTING] Simpan ID pembuat
                    creatorName: currentUser.displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                joinRoom(docRef.id);
            } catch (error) { console.error("Error membuat room: ", error); showToast('Gagal membuat room.', 'error'); }
        });
        
        // [PERUBAHAN] GANTI joinRoomForm (ganti alert)
        joinRoomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomId = document.getElementById('join-room-id').value;
            const password = document.getElementById('join-room-password').value;
            if (!roomId) { showToast('ID Room tidak boleh kosong!', 'error'); return; }
            try {
                const docRef = db.collection('drawingRooms').doc(roomId);
                const docSnap = await docRef.get();
                if (!docSnap.exists) { showToast('Room tidak ditemukan!', 'error'); return; }
                const roomData = docSnap.data();
                if (!roomData.isPublic && roomData.password !== password) {
                    showToast('Kata sandi salah!', 'error'); return; }
                joinRoom(roomId);
            } catch (error) { console.error("Error gabung room: ", error); showToast('Gagal gabung room.', 'error'); }
        });
        
        joinPublicBtn.addEventListener('click', () => {
            joinRoom('public_board');
        });
        
        // [PERUBAHAN] GANTI fungsi joinRoom
        async function joinRoom(roomId) {
            currentRoomId = roomId;
            allStrokes = [];
            console.log(`Bergabung ke room: ${roomId}`);

            try {
                // Ambil data room untuk cek siapa owner
                const roomDoc = await db.collection('drawingRooms').doc(roomId).get();
                if (roomDoc.exists) {
                    currentRoomData = roomDoc.data();
                    if (currentRoomData.creatorId === currentUser.uid) {
                        isRoomOwner = true;
                        console.log("Anda adalah Owner room ini.");
                    } else {
                        isRoomOwner = false;
                    }
                } else if (roomId === 'public_board') {
                    isRoomOwner = false; // Tidak ada owner di public board
                    currentRoomData = { name: "Papan Publik", creatorId: null }; // Data dummy
                } else {
                    showToast('Room ini sepertinya tidak ada lagi.', 'error');
                    return;
                }

                // Mulai lacak
                updateUserPresence(roomId); 
                listenForUsersInRoom(roomId); 
                listenForMyStatus(roomId); // [BARU] Dengarkan status kita (untuk kick)
                listenForRoomDeletion(roomId); // [BARU] Dengarkan jika room dihapus
                listenForStrokes();
                
                showView('drawing');
                showToast(`Selamat datang di room "${currentRoomData.name}"`, 'success');

            } catch (error) {
                console.error("Gagal join room: ", error);
                showToast('Gagal bergabung ke room.', 'error');
            }
        }
        
        // [PERUBAHAN] GANTI fungsi leaveRoomBtn.addEventListener
        leaveRoomBtn.addEventListener('click', () => {
            if (drawingListener) drawingListener(); 
            drawingListener = null;
            
            if (roomUsersListener) roomUsersListener();
            roomUsersListener = null;

            if (myStatusListener) myStatusListener(); // [BARU]
            myStatusListener = null;
            
            if (roomDocListener) roomDocListener(); // [BARU]
            roomDocListener = null;

            if (userPresenceInterval) clearInterval(userPresenceInterval);
            userPresenceInterval = null;
            
            removeUserPresence(); // Hapus status kita dari room

            currentRoomId = null;
            allStrokes = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showView('lobby'); // Kembali ke lobi
        });

        // ... (getParticipantsRef, updateUserPresence, removeUserPresence tetap sama) ...
        function getParticipantsRef(roomId = null) {
            if (!roomId && !currentRoomId) return null;
            return db.collection('drawingRooms').doc(roomId || currentRoomId).collection('participants');
        }
        function updateUserPresence(roomId) {
            if (!currentUser) return;
            const participantsRef = getParticipantsRef(roomId);
            if (!participantsRef) return;
            const myRef = participantsRef.doc(currentUser.uid);
            const presenceData = {
                displayName: currentUser.displayName, photoURL: currentUser.photoURL,
                uid: currentUser.uid, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), isDrawing: false 
            };
            myRef.set(presenceData, { merge: true });
            if (userPresenceInterval) clearInterval(userPresenceInterval);
            userPresenceInterval = setInterval(() => {
                myRef.set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            }, 60000);
        }
        async function removeUserPresence() {
            if (!currentUser || !currentRoomId) return;
            if (userPresenceInterval) clearInterval(userPresenceInterval);
            const myRef = getParticipantsRef().doc(currentUser.uid);
            try { await myRef.delete(); } catch (error) { console.error("Gagal hapus status: ", error); }
        }

        // [BARU] Fungsi untuk mendeteksi jika kita di-kick
        function listenForMyStatus(roomId) {
            if (myStatusListener) myStatusListener();
            if (!currentUser) return;
            myStatusListener = getParticipantsRef(roomId).doc(currentUser.uid)
                .onSnapshot(doc => {
                    if (!doc.exists) {
                        // Dokumen kita dihapus -> kita di-kick
                        showToast('Anda telah dikeluarkan dari room.', 'error');
                        leaveRoomBtn.click(); // Paksa keluar room
                    }
                });
        }

        // [BARU] Fungsi untuk mendeteksi jika room dihapus
        function listenForRoomDeletion(roomId) {
            if (roomDocListener) roomDocListener();
            if (roomId === 'public_board') return; // Papan publik tidak bisa dihapus
            
            roomDocListener = db.collection('drawingRooms').doc(roomId)
                .onSnapshot(doc => {
                    if (!doc.exists) {
                        showToast('Room ini telah dihapus oleh owner.', 'error');
                        leaveRoomBtn.click(); // Paksa keluar
                    }
                });
        }

        // [BARU] Fungsi untuk men-kick user (hanya owner)
        async function kickUser(userId, displayName) {
            if (!isRoomOwner || currentRoomId === 'public_board') {
                showToast('Hanya owner yang bisa kick pengguna.', 'error');
                return;
            }
            
            showConfirm(`Keluarkan ${displayName}?`, `Anda yakin ingin mengeluarkan "${displayName}" dari room?`, async () => {
                try {
                    await getParticipantsRef().doc(userId).delete();
                    showToast(`"${displayName}" telah dikeluarkan.`, 'success');
                } catch (error) {
                    console.error("Gagal kick user: ", error);
                    showToast('Gagal mengeluarkan pengguna.', 'error');
                }
            });
        }
        
        // [BARU] Fungsi untuk menghapus room (hanya owner)
        async function deleteRoom() {
            if (!isRoomOwner || currentRoomId === 'public_board') {
                showToast('Hanya owner yang bisa menghapus room.', 'error');
                return;
            }
            
            showConfirm('HAPUS ROOM?', `Anda YAKIN ingin menghapus room "${currentRoomData.name}"? Tindakan ini tidak bisa dibatalkan dan semua orang akan dikeluarkan.`, async () => {
                try {
                    // Menghapus dokumen room akan memicu listener 'listenForRoomDeletion'
                    // untuk semua orang (termasuk owner) dan memaksa keluar.
                    await db.collection('drawingRooms').doc(currentRoomId).delete();
                    showToast('Room berhasil dihapus.', 'success');
                    settingsModal.classList.remove('active'); // Tutup modal settings
                } catch (error) {
                    console.error("Gagal hapus room: ", error);
                    showToast('Gagal menghapus room.', 'error');
                }
            });
        }
        deleteRoomBtn.addEventListener('click', deleteRoom);


        // [PERUBAHAN] GANTI fungsi listenForUsersInRoom
        function listenForUsersInRoom(roomId) {
            if (roomUsersListener) roomUsersListener();
            const participantsRef = getParticipantsRef(roomId);

            roomUsersListener = participantsRef
                .where('lastSeen', '>', new Date(Date.now() - 120000)) // 2 menit
                .onSnapshot(snapshot => {
                    userListContent.innerHTML = '';
                    if (snapshot.empty) {
                        userListContent.innerHTML = '<p style="color: var(--muted);">Hanya Anda di sini.</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userEl = document.createElement('div');
                        userEl.className = 'user-item';
                        
                        let statusText = 'Online';
                        let statusClass = '';
                        if (user.isDrawing) {
                            statusText = 'Sedang menggambar...';
                            statusClass = 'drawing';
                        }
                        
                        let kickButtonHtml = '';
                        if (isRoomOwner && user.uid !== currentUser.uid && currentRoomId !== 'public_board') {
                            kickButtonHtml = `<button class="kick-btn" data-uid="${user.uid}" data-name="${user.displayName}" title="Keluarkan ${user.displayName}"><i class="fas fa-sign-out-alt"></i></button>`;
                        }

                        userEl.innerHTML = `
                            <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="${user.displayName}">
                            <div class="user-item-info">
                                <strong>${user.displayName}</strong>
                                <span class="${statusClass}">${statusText}</span>
                            </div>
                            ${kickButtonHtml}
                        `;
                        userListContent.appendChild(userEl);
                    });

                    document.querySelectorAll('.kick-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const target = e.currentTarget;
                            kickUser(target.dataset.uid, target.dataset.name);
                        });
                    });
                });
        }
        
        // ... (setDrawingStatus tetap sama) ...
        function setDrawingStatus(isDrawing) {
            if (!currentUser || !currentRoomId) return;
            const myRef = getParticipantsRef().doc(currentUser.uid);
            myRef.set({ isDrawing: isDrawing }, { merge: true });
        }


        // =========================================================
        // 6. Logika Sinkronisasi Gambar (Firestore)
        // =========================================================
        
        // ... (drawStroke, redrawFullCanvas, listenForStrokes, saveStrokeToFirestore tetap sama) ...
        function drawStroke(strokeData) {
            ctx.beginPath();
            ctx.strokeStyle = strokeData.color; ctx.lineWidth = strokeData.size;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (strokeData.tool === 'marker') { ctx.globalAlpha = 0.3; } else { ctx.globalAlpha = 1.0; }
            if (!strokeData.points || strokeData.points.length === 0) return;
            ctx.moveTo(strokeData.points[0].x * canvas.width, strokeData.points[0].y * canvas.height);
            for (let i = 1; i < strokeData.points.length; i++) {
                ctx.lineTo(strokeData.points[i].x * canvas.width, strokeData.points[i].y * canvas.height);
            }
            ctx.stroke(); ctx.closePath(); ctx.globalAlpha = 1.0;
        }
        function redrawFullCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            allStrokes.forEach(stroke => { drawStroke(stroke); });
        }
        function listenForStrokes() {
            if (drawingListener) drawingListener(); 
            if (!currentRoomId) return;
            const strokesCol = db.collection('drawingStrokes').doc(currentRoomId).collection('strokes');
            drawingListener = strokesCol.orderBy('timestamp').onSnapshot(snapshot => {
                allStrokes = []; 
                snapshot.forEach(doc => { allStrokes.push(doc.data()); });
                redrawFullCanvas();
            }, error => {
                console.error("Error mendengarkan goresan: ", error);
                showToast("Koneksi ke papan gambar terputus.", 'error');
                leaveRoomBtn.click(); 
            });
        }
        async function saveStrokeToFirestore(strokeData) {
            if (!currentRoomId || !currentUser) return;
            try {
                const strokesCol = db.collection('drawingStrokes').doc(currentRoomId).collection('strokes');
                await strokesCol.add({
                    ...strokeData, userId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) { console.error("Gagal menyimpan goresan: ", error); }
        }
        
        // =========================================================
        // 7. Logika Canvas & Alat Gambar
        // =========================================================
        
        // ... (getCanvasColor, getMousePos tetap sama) ...
        function getCanvasColor() { return getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim(); }
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX - rect.left) / rect.width, y: (e.clientY - rect.top) / rect.height };
        }
        
        // ... (startDraw, draw, stopDraw, resizeCanvas tetap sama) ...
        function startDraw(e) {
            setDrawingStatus(true); toolbar.classList.add('toolbar-hidden'); isDrawing = true;
            const pos = getMousePos(e);
            let strokeColor = (currentTool === 'eraser') ? getCanvasColor() : currentColor;
            let strokeSize = (currentTool === 'eraser') ? currentSize * 2 : currentSize;
            currentStroke = { tool: currentTool, color: strokeColor, size: strokeSize, points: [pos] };
            ctx.beginPath(); ctx.strokeStyle = strokeColor; ctx.lineWidth = strokeSize;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (currentTool === 'marker') { ctx.globalAlpha = 0.3; } else { ctx.globalAlpha = 1.0; }
            ctx.moveTo(pos.x * canvas.width, pos.y * canvas.height);
        }
        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            currentStroke.points.push(pos);
            ctx.lineTo(pos.x * canvas.width, pos.y * canvas.height); ctx.stroke();
        }
        function stopDraw() {
            setDrawingStatus(false); toolbar.classList.remove('toolbar-hidden'); 
            if (!isDrawing) return; isDrawing = false; ctx.closePath(); ctx.globalAlpha = 1.0; 
            if (currentStroke.points.length > 1) { saveStrokeToFirestore(currentStroke); }
        }
        function resizeCanvas() {
            canvas.width = drawingContainer.clientWidth; canvas.height = drawingContainer.clientHeight;
            redrawFullCanvas();
        }
        
        // ... (setActiveTool, tool listeners, color/size listeners tetap sama) ...
        function setActiveTool(selectedTool) {
            toolPen.classList.remove('active'); toolMarker.classList.remove('active'); toolEraser.classList.remove('active');
            if (selectedTool === 'pen') { currentTool = 'pen'; toolPen.classList.add('active'); }
            else if (selectedTool === 'marker') { currentTool = 'marker'; toolMarker.classList.add('active'); }
            else if (selectedTool === 'eraser') { currentTool = 'eraser'; toolEraser.classList.add('active'); }
        }
        toolPen.addEventListener('click', () => setActiveTool('pen'));
        toolMarker.addEventListener('click', () => setActiveTool('marker'));
        toolEraser.addEventListener('click', () => setActiveTool('eraser'));
        colorPicker.addEventListener('input', (e) => { currentColor = e.target.value; setActiveTool('pen'); });
        sizeSlider.addEventListener('input', (e) => { currentSize = e.target.value; });
        
        // [PERUBAHAN] GANTI clearCanvasBtn (Hanya Owner)
        clearCanvasBtn.addEventListener('click', async () => {
            if (!currentRoomId || !isRoomOwner) return;
            
            showConfirm('Bersihkan Papan?', 'ANDA ADALAH OWNER. Yakin ingin membersihkan SELURUH papan gambar untuk semua orang?', async () => {
                try {
                    const strokesCol = db.collection('drawingStrokes').doc(currentRoomId).collection('strokes');
                    const snapshot = await strokesCol.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                    showToast('Papan gambar telah dibersihkan.', 'success');
                } catch (error) {
                    console.error("Gagal membersihkan papan: ", error);
                    showToast('Gagal membersihkan papan.', 'error');
                }
            });
        });
        
        // [PERUBAHAN] GANTI clearMyCanvasBtn (ganti confirm/alert)
        clearMyCanvasBtn.addEventListener('click', async () => {
            if (!currentRoomId || !currentUser) return;
            
            showConfirm('Hapus Goresan Saya?', 'Anda yakin ingin menghapus SEMUA goresan milik Anda di papan ini?', async () => {
                try {
                    const strokesCol = db.collection('drawingStrokes').doc(currentRoomId).collection('strokes');
                    const snapshot = await strokesCol.where('userId', '==', currentUser.uid).get();
                    if (snapshot.empty) { showToast("Anda belum menggambar apa-apa.", 'info'); return; }
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                    showToast('Goresan Anda telah dihapus.', 'success');
                } catch (error) {
                    console.error("Gagal membersihkan goresan saya: ", error);
                    showToast("Gagal menghapus goresan Anda.", 'error');
                }
            });
        });

        // ... (downloadBtn, canvas listeners, window resize tetap sama) ...
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `fanra-board-${currentRoomId || 'image'}.png`;
            link.href = canvas.toDataURL(); link.click();
        });
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
        window.addEventListener('resize', () => { if (currentRoomId) { resizeCanvas(); } });

        // =========================================================
        // 8. Logika Autentikasi & Inisialisasi
        // =========================================================

        // [PERUBAHAN] GANTI googleLoginButton (ganti alert)
        googleLoginButton.addEventListener('click', async () => {
            try { await auth.signInWithPopup(googleProvider); } 
            catch (error) { console.error("Login failed:", error); showToast("Gagal masuk: " + error.message, 'error'); }
        });
        
        logoutButton.addEventListener('click', async () => { await auth.signOut(); });
        
        // [PERUBAHAN] GANTI updateUsernameButton (ganti alert)
        updateUsernameButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            const newName = newUsernameInput.value.trim();
            if (!user || !newName) return;
            try {
                await user.updateProfile({ displayName: newName });
                await db.collection('users').doc(user.uid).update({ displayName: newName });
                if (currentRoomId) { 
                    getParticipantsRef().doc(user.uid).update({ displayName: newName });
                }
                showToast("Username berhasil diperbarui!", 'success');
                settingsModal.classList.remove('active'); // Tutup modal
            } catch (error) {
                console.error("Error updating username:", error);
                showToast("Gagal memperbarui username.", 'error');
            }
        });
        
        // [PERUBAHAN] GANTI event listener 'f'
        document.addEventListener('keydown', (e) => {
            const activeEl = document.activeElement;
            const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA');

            if (e.key === 'f' || e.key === 'F') {
                if (isTyping) return; // [LOGIKA CERDAS] Jangan fullscreen jika sedang mengetik
                e.preventDefault(); 
                toggleFullscreen(); // [BARU] Panggil fungsi fullscreen
            } 
            if (e.key === "Escape") {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => modal.classList.remove('active'));
            }
        });

        // [PERUBAHAN] GANTI Listener Utama Auth (untuk sinkronisasi profil)
        auth.onAuthStateChanged(user => {
            if (user) {
                appContainer.style.display = 'flex'; 
                authScreen.style.display = 'none';
                
                const userRef = db.collection('users').doc(user.uid);
                userRef.set({
                    displayName: user.displayName || 'Anonim',
                    email: user.email,
                    photoURL: user.photoURL
                }, { merge: true }).then(() => {
                    userRef.get().then(doc => {
                        if (doc.exists) {
                            currentUser = doc.data(); 
                            currentUser.uid = user.uid; 
                        } else {
                            currentUser = user; 
                        }
                    });
                });
                
                showView('lobby');
                listenForPublicRooms();
                
            } else {
                currentUser = null;
                appContainer.style.display = 'none';
                authScreen.style.display = 'flex';
                
                if (drawingListener) drawingListener();
                if (roomListListener) roomListListener();
                if (roomUsersListener) roomUsersListener();
                if (myStatusListener) myStatusListener();
                if (roomDocListener) roomDocListener(); // [BARU]
                if (userPresenceInterval) clearInterval(userPresenceInterval);
                
                showView('lobby');
            }
        });

    </script>
</body>
</html>